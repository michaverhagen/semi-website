#!/usr/bin/env bash
set -e # halt script on error

echo "...building assets 'css' and 'js':"

# Build assets 'css' and 'js'
# note: needs to happen before jekyll build so these assets are copied over
if [ "${TRAVIS_BRANCH}" = "master" ]; then
    npm run build
else
    npm run build:dev
fi

# set URL for environments
if [ "${TRAVIS_BRANCH}" = "develop" ]; then
    BASE_URL="https://www.semi.technology"
elif [ "${TRAVIS_BRANCH}" = "master" ]; then
    BASE_URL="http://dev.semi.technology"
else
    BASE_URL=""
fi

echo "Setting base URL to: ${BASE_URL} and build site into './_site'..."

# Build html based on base url
if [ -z "$BASE_URL" ]; then
    JEKYLL_ENV=develop bundle exec jekyll build
else
    JEKYLL_ENV=develop bundle exec jekyll build --baseurl "$BASE_URL"
fi

echo "...test the HTML:"

# test the html
bundle exec htmlproofer ./_site --internal-domains www.semi.technology --allow-hash-href --url-ignore "https://codepen.io" --empty-alt-ignore --assume-extension
